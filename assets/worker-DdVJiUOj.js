var de=Object.defineProperty;var ce=(O,w,U)=>w in O?de(O,w,{enumerable:!0,configurable:!0,writable:!0,value:U}):O[w]=U;var u=(O,w,U)=>ce(O,typeof w!="symbol"?w+"":w,U);(function(){"use strict";class D{constructor(){u(this,"buf");u(this,"buf_len")}static read_bytes(s,e){const i=new D;return i.buf=s.getUint32(e,!0),i.buf_len=s.getUint32(e+4,!0),i}static read_bytes_array(s,e,i){const o=[];for(let t=0;t<i;t++)o.push(D.read_bytes(s,e+8*t));return o}}class A{constructor(){u(this,"buf");u(this,"buf_len")}static read_bytes(s,e){const i=new A;return i.buf=s.getUint32(e,!0),i.buf_len=s.getUint32(e+4,!0),i}static read_bytes_array(s,e,i){const o=[];for(let t=0;t<i;t++)o.push(A.read_bytes(s,e+8*t));return o}}const H=0,K=1,P=2,N=3,x=4;class B{constructor(s,e,i){u(this,"d_next");u(this,"d_ino",0n);u(this,"d_namlen");u(this,"d_type");u(this,"dir_name");const o=new TextEncoder().encode(e);this.d_next=s,this.d_namlen=o.byteLength,this.d_type=i,this.dir_name=o}head_length(){return 24}name_length(){return this.dir_name.byteLength}write_head_bytes(s,e){s.setBigUint64(e,this.d_next,!0),s.setBigUint64(e+8,this.d_ino,!0),s.setUint32(e+16,this.dir_name.length,!0),s.setUint8(e+20,this.d_type)}write_name_bytes(s,e,i){s.set(this.dir_name.slice(0,Math.min(this.dir_name.byteLength,i)),e)}}const X=1;class z{constructor(s,e){u(this,"fs_filetype");u(this,"fs_flags");u(this,"fs_rights_base",0n);u(this,"fs_rights_inherited",0n);this.fs_filetype=s,this.fs_flags=e}write_bytes(s,e){s.setUint8(e,this.fs_filetype),s.setUint16(e+2,this.fs_flags,!0),s.setBigUint64(e+8,this.fs_rights_base,!0),s.setBigUint64(e+16,this.fs_rights_inherited,!0)}}const I=1,T=2,M=4,V=8;class j{constructor(s,e){u(this,"dev",0n);u(this,"ino",0n);u(this,"filetype");u(this,"nlink",0n);u(this,"size");u(this,"atim",0n);u(this,"mtim",0n);u(this,"ctim",0n);this.filetype=s,this.size=e}write_bytes(s,e){s.setBigUint64(e,this.dev,!0),s.setBigUint64(e+8,this.ino,!0),s.setUint8(e+16,this.filetype),s.setBigUint64(e+24,this.nlink,!0),s.setBigUint64(e+32,this.size,!0),s.setBigUint64(e+38,this.atim,!0),s.setBigUint64(e+46,this.mtim,!0),s.setBigUint64(e+52,this.ctim,!0)}}const $=0;class q{constructor(s){u(this,"pr_name");this.pr_name=new TextEncoder().encode(s)}write_bytes(s,e){s.setUint32(e,this.pr_name.byteLength,!0)}}class F{constructor(){u(this,"tag");u(this,"inner")}static dir(s){const e=new F;return e.tag=$,e.inner=new q(s),e}write_bytes(s,e){s.setUint32(e,this.tag,!0),this.inner.write_bytes(s,e+4)}}class J{constructor(s){u(this,"prefix","wasi:");u(this,"log");this.isEnabled=s,this.log=W(s,this.prefix)}enable(s){this.log=W(s===void 0?!0:s,this.prefix)}get enabled(){return this.isEnabled}}function W(R,s){return R?console.log.bind(console,"%c%s","color: #265BA0",s):()=>{}}const E=new J(!1);class G extends Error{constructor(s){super("exit with exit code "+s),this.code=s}}class Q{constructor(s,e,i,o={}){u(this,"args",[]);u(this,"env",[]);u(this,"fds",[]);u(this,"inst");u(this,"wasiImport");E.enable(o.debug),this.args=s,this.env=e,this.fds=i,this.inst={exports:{memory:new WebAssembly.Memory({initial:0,maximum:0,shared:!1})}};const t=this;this.wasiImport={args_sizes_get(r,n){const a=new DataView(t.inst.exports.memory.buffer);a.setUint32(r,t.args.length,!0);let f=0;for(const l of t.args)f+=l.length+1;return a.setUint32(n,f,!0),E.log(a.getUint32(r,!0),a.getUint32(n,!0)),0},args_get(r,n){const a=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer),l=n;for(let _=0;_<t.args.length;_++){a.setUint32(r,n,!0),r+=4;const d=new TextEncoder().encode(t.args[_]);f.set(d,n),a.setUint8(n+d.length,0),n+=d.length+1}return E.enabled&&E.log(new TextDecoder("utf-8").decode(f.slice(l,n))),0},environ_sizes_get(r,n){const a=new DataView(t.inst.exports.memory.buffer);a.setUint32(r,t.env.length,!0);let f=0;for(const l of t.env)f+=l.length+1;return a.setUint32(n,f,!0),E.log(a.getUint32(r,!0),a.getUint32(n,!0)),0},environ_get(r,n){const a=new DataView(t.inst.exports.memory.buffer),f=new Uint8Array(t.inst.exports.memory.buffer),l=n;for(let _=0;_<t.env.length;_++){a.setUint32(r,n,!0),r+=4;const d=new TextEncoder().encode(t.env[_]);f.set(d,n),a.setUint8(n+d.length,0),n+=d.length+1}return E.enabled&&E.log(new TextDecoder("utf-8").decode(f.slice(l,n))),0},clock_res_get(r,n){let a;switch(r){case 1:{a=5000n;break}case 0:{a=1000000n;break}default:return 52}return new DataView(t.inst.exports.memory.buffer).setBigUint64(n,a,!0),0},clock_time_get(r,n,a){const f=new DataView(t.inst.exports.memory.buffer);if(r===0)f.setBigUint64(a,BigInt(new Date().getTime())*1000000n,!0);else if(r==1){let l;try{l=BigInt(Math.round(performance.now()*1e6))}catch{l=0n}f.setBigUint64(a,l,!0)}else f.setBigUint64(a,0n,!0);return 0},fd_advise(r,n,a,f){return t.fds[r]!=null?0:8},fd_allocate(r,n,a){return t.fds[r]!==void 0?t.fds[r].fd_allocate(n,a):8},fd_close(r){if(t.fds[r]!==void 0){const n=t.fds[r].fd_close();return t.fds[r]=void 0,n}else return 8},fd_datasync(r){return t.fds[r]!=null?t.fds[r].fd_sync():8},fd_fdstat_get(r,n){if(t.fds[r]!=null){const{ret:a,fdstat:f}=t.fds[r].fd_fdstat_get();return f!=null&&f.write_bytes(new DataView(t.inst.exports.memory.buffer),n),a}else return 8},fd_fdstat_set_flags(r,n){return t.fds[r]!=null?t.fds[r].fd_fdstat_set_flags(n):8},fd_fdstat_set_rights(r,n,a){return t.fds[r]!=null?t.fds[r].fd_fdstat_set_rights(n,a):8},fd_filestat_get(r,n){if(t.fds[r]!=null){const{ret:a,filestat:f}=t.fds[r].fd_filestat_get();return f!=null&&f.write_bytes(new DataView(t.inst.exports.memory.buffer),n),a}else return 8},fd_filestat_set_size(r,n){return t.fds[r]!=null?t.fds[r].fd_filestat_set_size(n):8},fd_filestat_set_times(r,n,a,f){return t.fds[r]!=null?t.fds[r].fd_filestat_set_times(n,a,f):8},fd_pread(r,n,a,f,l){const _=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=D.read_bytes_array(_,n,a);let b=0;for(const h of c){const{ret:p,data:y}=t.fds[r].fd_pread(h.buf_len,f);if(p!=0)return _.setUint32(l,b,!0),p;if(d.set(y,h.buf),b+=y.length,f+=BigInt(y.length),y.length!=h.buf_len)break}return _.setUint32(l,b,!0),0}else return 8},fd_prestat_get(r,n){const a=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:f,prestat:l}=t.fds[r].fd_prestat_get();return l!=null&&l.write_bytes(a,n),f}else return 8},fd_prestat_dir_name(r,n,a){if(t.fds[r]!=null){const{ret:f,prestat:l}=t.fds[r].fd_prestat_get();if(l==null)return f;const _=l.inner.pr_name;return new Uint8Array(t.inst.exports.memory.buffer).set(_.slice(0,a),n),_.byteLength>a?37:0}else return 8},fd_pwrite(r,n,a,f,l){const _=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=A.read_bytes_array(_,n,a);let b=0;for(const h of c){const p=d.slice(h.buf,h.buf+h.buf_len),{ret:y,nwritten:S}=t.fds[r].fd_pwrite(p,f);if(y!=0)return _.setUint32(l,b,!0),y;if(b+=S,f+=BigInt(S),S!=p.byteLength)break}return _.setUint32(l,b,!0),0}else return 8},fd_read(r,n,a,f){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const d=D.read_bytes_array(l,n,a);let c=0;for(const b of d){const{ret:h,data:p}=t.fds[r].fd_read(b.buf_len);if(h!=0)return l.setUint32(f,c,!0),h;if(_.set(p,b.buf),c+=p.length,p.length!=b.buf_len)break}return l.setUint32(f,c,!0),0}else return 8},fd_readdir(r,n,a,f,l){const _=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){let c=0;for(;;){const{ret:b,dirent:h}=t.fds[r].fd_readdir_single(f);if(b!=0)return _.setUint32(l,c,!0),b;if(h==null)break;if(a-c<h.head_length()){c=a;break}const p=new ArrayBuffer(h.head_length());if(h.write_head_bytes(new DataView(p),0),d.set(new Uint8Array(p).slice(0,Math.min(p.byteLength,a-c)),n),n+=h.head_length(),c+=h.head_length(),a-c<h.name_length()){c=a;break}h.write_name_bytes(d,n,a-c),n+=h.name_length(),c+=h.name_length(),f=h.d_next}return _.setUint32(l,c,!0),0}else return 8},fd_renumber(r,n){if(t.fds[r]!=null&&t.fds[n]!=null){const a=t.fds[n].fd_close();return a!=0?a:(t.fds[n]=t.fds[r],t.fds[r]=void 0,0)}else return 8},fd_seek(r,n,a,f){const l=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:_,offset:d}=t.fds[r].fd_seek(n,a);return l.setBigInt64(f,d,!0),_}else return 8},fd_sync(r){return t.fds[r]!=null?t.fds[r].fd_sync():8},fd_tell(r,n){const a=new DataView(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const{ret:f,offset:l}=t.fds[r].fd_tell();return a.setBigUint64(n,l,!0),f}else return 8},fd_write(r,n,a,f){const l=new DataView(t.inst.exports.memory.buffer),_=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const d=A.read_bytes_array(l,n,a);let c=0;for(const b of d){const h=_.slice(b.buf,b.buf+b.buf_len),{ret:p,nwritten:y}=t.fds[r].fd_write(h);if(p!=0)return l.setUint32(f,c,!0),p;if(c+=y,y!=h.byteLength)break}return l.setUint32(f,c,!0),0}else return 8},path_create_directory(r,n,a){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const l=new TextDecoder("utf-8").decode(f.slice(n,n+a));return t.fds[r].path_create_directory(l)}else return 8},path_filestat_get(r,n,a,f,l){const _=new DataView(t.inst.exports.memory.buffer),d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const c=new TextDecoder("utf-8").decode(d.slice(a,a+f)),{ret:b,filestat:h}=t.fds[r].path_filestat_get(n,c);return h!=null&&h.write_bytes(_,l),b}else return 8},path_filestat_set_times(r,n,a,f,l,_,d){const c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const b=new TextDecoder("utf-8").decode(c.slice(a,a+f));return t.fds[r].path_filestat_set_times(n,b,l,_,d)}else return 8},path_link(r,n,a,f,l,_,d){const c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null&&t.fds[l]!=null){const b=new TextDecoder("utf-8").decode(c.slice(a,a+f)),h=new TextDecoder("utf-8").decode(c.slice(_,_+d)),{ret:p,inode_obj:y}=t.fds[r].path_lookup(b,n);return y==null?p:t.fds[l].path_link(h,y,!1)}else return 8},path_open(r,n,a,f,l,_,d,c,b){const h=new DataView(t.inst.exports.memory.buffer),p=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const y=new TextDecoder("utf-8").decode(p.slice(a,a+f));E.log(y);const{ret:S,fd_obj:_e}=t.fds[r].path_open(n,y,l,_,d,c);if(S!=0)return S;t.fds.push(_e||void 0);const ue=t.fds.length-1;return h.setUint32(b,ue,!0),0}else return 8},path_readlink(r,n,a,f,l,_){const d=new DataView(t.inst.exports.memory.buffer),c=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const b=new TextDecoder("utf-8").decode(c.slice(n,n+a));E.log(b);const{ret:h,data:p}=t.fds[r].path_readlink(b);if(p!=null){const y=new TextEncoder().encode(p);if(y.length>l)return d.setUint32(_,0,!0),8;c.set(y,f),d.setUint32(_,y.length,!0)}return h}else return 8},path_remove_directory(r,n,a){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const l=new TextDecoder("utf-8").decode(f.slice(n,n+a));return t.fds[r].path_remove_directory(l)}else return 8},path_rename(r,n,a,f,l,_){const d=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null&&t.fds[f]!=null){const c=new TextDecoder("utf-8").decode(d.slice(n,n+a)),b=new TextDecoder("utf-8").decode(d.slice(l,l+_));let{ret:h,inode_obj:p}=t.fds[r].path_unlink(c);if(p==null)return h;if(h=t.fds[f].path_link(b,p,!0),h!=0&&t.fds[r].path_link(c,p,!0)!=0)throw"path_link should always return success when relinking an inode back to the original place";return h}else return 8},path_symlink(r,n,a,f,l){const _=new Uint8Array(t.inst.exports.memory.buffer);return t.fds[a]!=null?(new TextDecoder("utf-8").decode(_.slice(r,r+n)),new TextDecoder("utf-8").decode(_.slice(f,f+l)),58):8},path_unlink_file(r,n,a){const f=new Uint8Array(t.inst.exports.memory.buffer);if(t.fds[r]!=null){const l=new TextDecoder("utf-8").decode(f.slice(n,n+a));return t.fds[r].path_unlink_file(l)}else return 8},poll_oneoff(r,n,a){throw"async io not supported"},proc_exit(r){throw new G(r)},proc_raise(r){throw"raised signal "+r},sched_yield(){},random_get(r,n){const a=new Uint8Array(t.inst.exports.memory.buffer).subarray(r,r+n);if("crypto"in globalThis)for(let f=0;f<n;f+=65536)crypto.getRandomValues(a.subarray(f,f+65536));else for(let f=0;f<n;f++)a[f]=Math.random()*256|0},sock_recv(r,n,a){throw"sockets not supported"},sock_send(r,n,a){throw"sockets not supported"},sock_shutdown(r,n){throw"sockets not supported"},sock_accept(r,n){throw"sockets not supported"}}}start(s){this.inst=s;try{return s.exports._start(),0}catch(e){if(e instanceof G)return e.code;throw e}}initialize(s){this.inst=s,s.exports._initialize&&s.exports._initialize()}}class k{fd_allocate(s,e){return 58}fd_close(){return 0}fd_fdstat_get(){return{ret:58,fdstat:null}}fd_fdstat_set_flags(s){return 58}fd_fdstat_set_rights(s,e){return 58}fd_filestat_get(){return{ret:58,filestat:null}}fd_filestat_set_size(s){return 58}fd_filestat_set_times(s,e,i){return 58}fd_pread(s,e){return{ret:58,data:new Uint8Array}}fd_prestat_get(){return{ret:58,prestat:null}}fd_pwrite(s,e){return{ret:58,nwritten:0}}fd_read(s){return{ret:58,data:new Uint8Array}}fd_readdir_single(s){return{ret:58,dirent:null}}fd_seek(s,e){return{ret:58,offset:0n}}fd_sync(){return 0}fd_tell(){return{ret:58,offset:0n}}fd_write(s){return{ret:58,nwritten:0}}path_create_directory(s){return 58}path_filestat_get(s,e){return{ret:58,filestat:null}}path_filestat_set_times(s,e,i,o,t){return 58}path_link(s,e,i){return 58}path_unlink(s){return{ret:58,inode_obj:null}}path_lookup(s,e){return{ret:58,inode_obj:null}}path_open(s,e,i,o,t,r){return{ret:54,fd_obj:null}}path_readlink(s){return{ret:58,data:null}}path_remove_directory(s){return 58}path_rename(s,e,i){return 58}path_unlink_file(s){return 58}}class Z{}class ee extends k{constructor(e){super();u(this,"file");u(this,"file_pos",0n);this.file=e}fd_allocate(e,i){if(!(this.file.size>e+i)){const o=new Uint8Array(Number(e+i));o.set(this.file.data,0),this.file.data=o}return 0}fd_fdstat_get(){return{ret:0,fdstat:new z(x,0)}}fd_filestat_set_size(e){if(this.file.size>e)this.file.data=new Uint8Array(this.file.data.buffer.slice(0,Number(e)));else{const i=new Uint8Array(Number(e));i.set(this.file.data,0),this.file.data=i}return 0}fd_read(e){const i=this.file.data.slice(Number(this.file_pos),Number(this.file_pos+BigInt(e)));return this.file_pos+=BigInt(i.length),{ret:0,data:i}}fd_pread(e,i){return{ret:0,data:this.file.data.slice(Number(i),Number(i+BigInt(e)))}}fd_seek(e,i){let o;switch(i){case H:o=e;break;case K:o=this.file_pos+e;break;case P:o=BigInt(this.file.data.byteLength)+e;break;default:return{ret:28,offset:0n}}return o<0?{ret:28,offset:0n}:(this.file_pos=o,{ret:0,offset:this.file_pos})}fd_tell(){return{ret:0,offset:this.file_pos}}fd_write(e){if(this.file.readonly)return{ret:8,nwritten:0};if(this.file_pos+BigInt(e.byteLength)>this.file.size){const i=this.file.data;this.file.data=new Uint8Array(Number(this.file_pos+BigInt(e.byteLength))),this.file.data.set(i)}return this.file.data.set(e,Number(this.file_pos)),this.file_pos+=BigInt(e.byteLength),{ret:0,nwritten:e.byteLength}}fd_pwrite(e,i){if(this.file.readonly)return{ret:8,nwritten:0};if(i+BigInt(e.byteLength)>this.file.size){const o=this.file.data;this.file.data=new Uint8Array(Number(i+BigInt(e.byteLength))),this.file.data.set(o)}return this.file.data.set(e,Number(i)),{ret:0,nwritten:e.byteLength}}fd_filestat_get(){return{ret:0,filestat:this.file.stat()}}}class Y extends k{constructor(e){super();u(this,"dir");this.dir=e}fd_seek(e,i){return{ret:8,offset:0n}}fd_tell(){return{ret:8,offset:0n}}fd_allocate(e,i){return 8}fd_fdstat_get(){return{ret:0,fdstat:new z(N,0)}}fd_readdir_single(e){if(E.enabled&&(E.log("readdir_single",e),E.log(e,this.dir.contents.keys())),e==0n)return{ret:0,dirent:new B(1n,".",N)};if(e==1n)return{ret:0,dirent:new B(2n,"..",N)};if(e>=BigInt(this.dir.contents.size)+2n)return{ret:0,dirent:null};const[i,o]=Array.from(this.dir.contents.entries())[Number(e-2n)];return{ret:0,dirent:new B(e+1n,i,o.stat().filetype)}}path_filestat_get(e,i){const{ret:o,path:t}=g.from(i);if(t==null)return{ret:o,filestat:null};const{ret:r,entry:n}=this.dir.get_entry_for_path(t);return n==null?{ret:r,filestat:null}:{ret:0,filestat:n.stat()}}path_lookup(e,i){const{ret:o,path:t}=g.from(e);if(t==null)return{ret:o,inode_obj:null};const{ret:r,entry:n}=this.dir.get_entry_for_path(t);return n==null?{ret:r,inode_obj:null}:{ret:0,inode_obj:n}}path_open(e,i,o,t,r,n){const{ret:a,path:f}=g.from(i);if(f==null)return{ret:a,fd_obj:null};let{ret:l,entry:_}=this.dir.get_entry_for_path(f);if(_==null){if(l!=44)return{ret:l,fd_obj:null};if((o&I)==I){const{ret:d,entry:c}=this.dir.create_entry_for_path(i,(o&T)==T);if(c==null)return{ret:d,fd_obj:null};_=c}else return{ret:44,fd_obj:null}}else if((o&M)==M)return{ret:20,fd_obj:null};return(o&T)==T&&_.stat().filetype!==N?{ret:54,fd_obj:null}:_.path_open(o,t,n)}path_create_directory(e){return this.path_open(0,e,I|T,0n,0n,0).ret}path_link(e,i,o){const{ret:t,path:r}=g.from(e);if(r==null)return t;if(r.is_dir)return 44;const{ret:n,parent_entry:a,filename:f,entry:l}=this.dir.get_parent_dir_and_entry_for_path(r,!0);if(a==null||f==null)return n;if(l!=null){const _=i.stat().filetype==N,d=l.stat().filetype==N;if(_&&d)if(o&&l instanceof m){if(l.contents.size!=0)return 55}else return 20;else{if(_&&!d)return 54;if(!_&&d)return 31;if(!(i.stat().filetype==x&&l.stat().filetype==x))return 20}}return!o&&i.stat().filetype==N?63:(a.contents.set(f,i),0)}path_unlink(e){const{ret:i,path:o}=g.from(e);if(o==null)return{ret:i,inode_obj:null};const{ret:t,parent_entry:r,filename:n,entry:a}=this.dir.get_parent_dir_and_entry_for_path(o,!0);return r==null||n==null?{ret:t,inode_obj:null}:a==null?{ret:44,inode_obj:null}:(r.contents.delete(n),{ret:0,inode_obj:a})}path_unlink_file(e){const{ret:i,path:o}=g.from(e);if(o==null)return i;const{ret:t,parent_entry:r,filename:n,entry:a}=this.dir.get_parent_dir_and_entry_for_path(o,!1);return r==null||n==null||a==null?t:a.stat().filetype===N?31:(r.contents.delete(n),0)}path_remove_directory(e){const{ret:i,path:o}=g.from(e);if(o==null)return i;const{ret:t,parent_entry:r,filename:n,entry:a}=this.dir.get_parent_dir_and_entry_for_path(o,!1);return r==null||n==null||a==null?t:!(a instanceof m)||a.stat().filetype!==N?54:a.contents.size!==0?55:r.contents.delete(n)?0:44}fd_filestat_get(){return{ret:0,filestat:this.dir.stat()}}fd_filestat_set_size(e){return 8}fd_read(e){return{ret:8,data:new Uint8Array}}fd_pread(e,i){return{ret:8,data:new Uint8Array}}fd_write(e){return{ret:8,nwritten:0}}fd_pwrite(e,i){return{ret:8,nwritten:0}}}class L extends Y{constructor(e,i){super(new m(i));u(this,"prestat_name");this.prestat_name=e}fd_prestat_get(){return{ret:0,prestat:F.dir(this.prestat_name)}}}class C extends Z{constructor(e,i){super();u(this,"data");u(this,"readonly");this.data=new Uint8Array(e),this.readonly=!!(i!=null&&i.readonly)}path_open(e,i,o){if(this.readonly&&(i&BigInt(64))==BigInt(64))return{ret:63,fd_obj:null};if((e&V)==V){if(this.readonly)return{ret:63,fd_obj:null};this.data=new Uint8Array([])}const t=new ee(this);return o&X&&t.fd_seek(0n,P),{ret:0,fd_obj:t}}get size(){return BigInt(this.data.byteLength)}stat(){return new j(x,this.size)}}class g{constructor(){u(this,"parts",[]);u(this,"is_dir",!1)}static from(s){const e=new g;if(e.is_dir=s.endsWith("/"),s.startsWith("/"))return{ret:76,path:null};if(s.includes("\0"))return{ret:28,path:null};for(const i of s.split("/"))if(!(i===""||i===".")){if(i===".."){if(e.parts.pop()==null)return{ret:76,path:null};continue}e.parts.push(i)}return{ret:0,path:e}}to_path_string(){let s=this.parts.join("/");return this.is_dir&&(s+="/"),s}}class m extends Z{constructor(e){super();u(this,"contents");e instanceof Array?this.contents=new Map(e):this.contents=e}path_open(e,i,o){return{ret:0,fd_obj:new Y(this)}}stat(){return new j(N,0n)}get_entry_for_path(e){let i=this;for(const o of e.parts){if(!(i instanceof m))return{ret:54,entry:null};const t=i.contents.get(o);if(t!==void 0)i=t;else return E.log(o),{ret:44,entry:null}}return e.is_dir&&i.stat().filetype!=N?{ret:54,entry:null}:{ret:0,entry:i}}get_parent_dir_and_entry_for_path(e,i){const o=e.parts.pop();if(o===void 0)return{ret:28,parent_entry:null,filename:null,entry:null};const{ret:t,entry:r}=this.get_entry_for_path(e);if(r==null)return{ret:t,parent_entry:null,filename:null,entry:null};if(!(r instanceof m))return{ret:54,parent_entry:null,filename:null,entry:null};const n=r.contents.get(o);return n===void 0?i?{ret:0,parent_entry:r,filename:o,entry:null}:{ret:44,parent_entry:null,filename:null,entry:null}:e.is_dir&&n.stat().filetype!=N?{ret:54,parent_entry:null,filename:null,entry:null}:{ret:0,parent_entry:r,filename:o,entry:n}}create_entry_for_path(e,i){const{ret:o,path:t}=g.from(e);if(t==null)return{ret:o,entry:null};let{ret:r,parent_entry:n,filename:a,entry:f}=this.get_parent_dir_and_entry_for_path(t,!0);if(n==null||a==null)return{ret:r,entry:null};if(f!=null)return{ret:20,entry:null};E.log("create",t);let l;return i?l=new m(new Map):l=new C(new ArrayBuffer(0)),n.contents.set(a,l),f=l,{ret:0,entry:f}}get_file(e){const i=this.contents.get(e);return i instanceof C?i:null}}function te(R,s){return new Proxy(R,{get(e,i,o){const t=Reflect.get(e,i,o);return s.includes(i)?t:function(...r){return Reflect.apply(t,o,r)}}})}var re="/const_struct_slide/rubri/bin/miri.opt.1718474653.wasm",ne="/const_struct_slide/rubri/lib/rustlib/x86_64-unknown-linux-gnu/lib/libaddr2line-b8754aeb03c02354.rlib";async function se(){console.time("init");const R=[],s=new v(R),e=new v(R),i=new v(R),o=new L("/tmp",[]),t=new L("/",[["main.rs",new C([])]]),n=await(await fetch(re)).arrayBuffer(),a=await oe(),f=[s,e,i,o,a,t],l=[],_=["miri","--sysroot","/sysroot","main.rs","--target","x86_64-unknown-linux-gnu","-Zmir-opt-level=3","-Zmiri-ignore-leaks","-Zmiri-permissive-provenance","-Zmiri-preemption-rate=0","-Zmiri-disable-alignment-check","-Zmiri-disable-data-race-detector","-Zmiri-disable-stacked-borrows","-Zmiri-disable-validation","-Zmir-emit-retag=false","-Zmiri-disable-isolation","-Zmiri-panic-on-unsupported","--color=always"],d=new Q(_,l,f,{debug:!1});return console.timeEnd("init"),new ie(n,d,f,s,e,i)}class ie{constructor(s,e,i,o,t,r){u(this,"miri");u(this,"wasi");u(this,"fds");u(this,"stdin");u(this,"stdout");u(this,"stderr");u(this,"next_thread_id");this.miri=s,this.wasi=e,this.stdin=o,this.stdout=r,this.stderr=t,this.fds=i,this.next_thread_id=1}async run(s,e=!1){this.stdin.clear(),this.stdout.clear(),this.stderr.clear(),s=`let _code = (|| {
${s}
})();`,e&&(s+=`
if std::any::Any::type_id(&_code) != std::any::TypeId::of::<()>() { println!("{_code:?}") }`),this.fds[5].dir.get_file("main.rs").data=le(`fn main() {
${s}
}`),console.log("Running code",s);const i=await WebAssembly.instantiate(this.miri,{env:{memory:new WebAssembly.Memory({initial:256,maximum:1024*4,shared:!1})},wasi:{"thread-spawn":function(o){let t=this.next_thread_id++;return i.exports.wasi_thread_start(t,o),t}},wasi_snapshot_preview1:te(this.wasi.wasiImport,["fd_prestat_get"])});console.log("inst",i);try{console.time("miri execution"),this.wasi.start(i.instance),console.timeEnd("miri execution")}catch(o){return this.stdout.text()||o.message}return this.stdout.text()}}class v extends k{constructor(e=[]){super();u(this,"out");this.out=e}fd_write(e){return this.out.push(e),{ret:0,nwritten:e.byteLength}}clear(){this.out.length=0}text(){const e=new TextDecoder("utf-8");let i="";for(const o of this.out)i+=e.decode(o);return i}}async function ae(R){return new C(await fe(R).then(s=>s.blob()).then(s=>s.arrayBuffer()))}async function fe(R){try{throw new Error("not cached")}catch{const t=await fetch(R,{cache:"force-cache"});return console.log("fetching",R,t),t}const s=await caches.open("rust-quest"),e=await s.match(R);if(e)return e;const i=await fetch(R);return s.put(R,i.clone()),i}async function oe(){return new L("/sysroot",[["lib",new m([["rustlib",new m([["wasm32-wasi",new m([["lib",new m([])]])],["x86_64-unknown-linux-gnu",new m([["lib",new m(await async function(){let R=new Map,s=["libaddr2line-b8754aeb03c02354.rlib","libadler-05c3545f6cd12159.rlib","liballoc-0dab879bc41cd6bd.rlib","libcfg_if-c7fd2cef50341546.rlib","libcompiler_builtins-a99947d020d809d6.rlib","libcore-4b8e8a815d049db3.rlib","libgetopts-bbb75529e85d129d.rlib","libgimli-598847d27d7a3cbf.rlib","libhashbrown-d2ff91fdf93cacb2.rlib","liblibc-dc63949c664c3fce.rlib","libmemchr-2d3a423be1a6cb96.rlib","libminiz_oxide-b109506a0ccc4c6a.rlib","libobject-7b48def7544c748b.rlib","libpanic_abort-c93441899b93b849.rlib","libpanic_unwind-11d9ba05b60bf694.rlib","libproc_macro-1a7f7840bb9983dc.rlib","librustc_demangle-59342a335246393d.rlib","librustc_std_workspace_alloc-552b185085090ff6.rlib","librustc_std_workspace_core-5d8a121daa7eeaa9.rlib","librustc_std_workspace_std-97f43841ce452f7d.rlib","libstd-bdedb7706a556da2.rlib","libstd-bdedb7706a556da2.so","libstd_detect-cca21eebc4281add.rlib","libsysroot-f654e185be3ffebd.rlib","libtest-f06fa3fbc201c558.rlib","libunicode_width-19a0dcd589fa0877.rlib","libunwind-747b693f90af9445.rlib"].map(async e=>{const i=ne.split("/");i.pop();const o=i.join("/")+"/";console.log("libs",o),R.set(e,await ae(o+e).finally(()=>postMessage({downloaded:e})))});return await Promise.all(s),R}())]])]])]])]])}function le(R){return new TextEncoder().encode(R)}(async()=>{const R=await se();console.log("initialized interpreter"),addEventListener("message",async s=>{const{code:e,printLast:i}=s.data,o=await R.run(e,i);postMessage({result:o})}),postMessage({loaded:!0})})()})();
